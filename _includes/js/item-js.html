{%- if site.data.theme.icons -%}{% assign icons = site.data.theme.icons %}{% else %}
{% assign cb_icons = site.pages | where: "name","cb-icons.svg" | first %}
{% assign icons = cb_icons.icons %}{%- endif -%}
{%- assign fields = site.data.config-metadata -%}
{%- assign stubs = site.data.config-nav | map: 'stub' | join: ';' -%}
{%- assign items = site.data[site.metadata] | where_exp: 'item','item.objectid' -%}
<script>
(function(){
    /* add item data */
    var items = { 
        {%- for item in items -%}{%- unless item.parentid %}
        {{ item.objectid | jsonify }} : { {% unless fields contains 'title' %}"title": {{ item.title | jsonify }}, {% endunless %}{% for f in fields %}{% if item[f.field] %}{{ f.field | jsonify }}: {{ item[f.field] | jsonify }}, {% endif %}{% endfor %}{% if item.youtubeid %} "youtube": {{ item.youtubeid | jsonify }}, {% endif %}{% if item.vimeoid %} "vimeo": {{ item.vimeoid | jsonify }}, {% endif %}"format": {{ item.format | jsonify }}, {% if  item.filename contains '/' %}"filename": "{{ item.filename }}" {% else %}"filename":{{ '/objects/' | relative_url | append: item.filename | jsonify }}{% endif %} }{% unless forloop.last %}, {% endunless %}
        {% endunless %}{% endfor %}
    };
    var children = { {%- assign parents = site.data[site.metadata] | map: 'parentid' | compact | uniq -%}{%- for p in parents -%}
        {{ p | jsonify }}: [
        {%- assign children = site.data[site.metadata] | where: 'parentid', p -%}
        {%- for c in children -%}
        { "id": {{ c.objectid | jsonify }}, {% if c.title %}{% unless fields contains 'title' %}"title": {{ c.title | jsonify }}, {% endunless %}{% endif %}{% for f in fields %}{% if c[f.field] %}{{ f.field | jsonify }}: {{ c[f.field] | jsonify }}, {% endif %}{% endfor %}{% if c.filename contains '/' %}"filename": "{{ c.filename }}" {% else %}"filename":{{ '/objects/' | relative_url | append: c.filename | jsonify }}{% endif %}, {% if c.youtubeid %}"youtube": {{ c.youtubeid | jsonify }}, {% endif %}{% if c.vimeoid %} "vimeo": {{ c.vimeoid }}, {% endif %}"format": {{ c.format | jsonify }} }
        {%- unless forloop.last -%}, {%- endunless -%}{%- endfor -%}]{%- unless forloop.last -%}, {%- endunless -%}{%- endfor -%}
    };

    /* get query id from URL */
    var queryString = window.location.search.substring(1).split("=")[1];
    var record = items[queryString];
    var compoundObject = children[queryString];

    if (record) {
        /* add item title */
        var objectTitle = record.title;
        document.getElementById("bc-title").innerHTML = objectTitle;
        document.getElementById("item-format").innerHTML = compoundObject ? record.format.replace("_", " ").toUpperCase() + ' (' + compoundObject.length + ' Items)' : record.format.replace("_", " ").toUpperCase();
        document.getElementById("item-title").innerHTML = objectTitle;
        /* add object */ 
        var format = "" + record.format;
        var objectLink = record.filename;
        var itemImage, itemLink;

        /* function to add item to page */
        var itemDisplay, itemDownload;
        function addItem(item) {
            if (item.format.includes('image')) {
                itemDisplay = '<div class="spotlight gallery-img" data-download="true" data-src="' + item.filename + '"><img class="img-fluid" src="' + item.filename + '" alt="' + item.title + '">';
                itemDisplay += record.format.includes('multiple') ? '</div>' : '<p class="text-center"><small>Click to view full screen</small></p></div>';
                itemDownload = '<a href="' + item.filename + '" target="_blank" rel="noopener" class="m-2 btn btn-dark" title="Object download">Download Image</a>';
            } else if (item.format.includes('pdf')) {
                itemDisplay = '<div class="ratio ratio-4x3"><object title="PDF file of ' + item.title + '" data="' + item.filename + '" type="application/pdf" width="100%"><p>The PDF is not rendering in your browser. Please use the button below to download the PDF.</p></object></div>';
                itemDownload = '<a href="' + item.filename + '" target="_blank" rel="noopener" class="m-2 btn btn-dark" title="Object download">Download PDF</a>';
            } else if (item.format.includes('audio')) {
                itemDisplay = '<audio controls class="w-100"><source src="' + item.filename + '">Your browser does not support the audio element.</audio>';
                itemDownload = '<a href="' + item.filename + '" target="_blank" rel="noopener" class="m-2 btn btn-dark" title="Object download">Download Audio File</a>';
            } else if (item.youtube) {
                itemDisplay = '<div class="ratio ratio-16x9"><iframe title="' + item.title + '" src="https://www.youtube-nocookie.com/embed/' + item.youtube + '?rel=0&modestbranding=1" allowfullscreen></iframe></div>';
                itemDownload = '<a href="https://youtu.be/' + item.youtube + '" target="_blank" rel="noopener" class="m-2 btn btn-dark" title="Object download">View on YouTube</a>';
            } else if (item.vimeo) {
                itemDisplay = '<div class="ratio ratio-16x9"><iframe title="' + item.title + '"src="https://player.vimeo.com/video/' + item.vimeo + '" allowfullscreen></iframe></div>';
                itemDownload = '<a href="https://vimeo.com/' + item.vimeo + '" target="_blank" rel="noopener" class="m-2 btn btn-dark" title="Object download">View on Vimeo</a>';
            } else if (item.format.includes('video')) {
                itemDisplay = '<video controls class="w-100"><source src="' + item.filename + '">Your browser does not support the video element.</audio>';
                itemDownload = '<a href="' + item.filename + '" target="_blank" rel="noopener" class="m-2 btn btn-dark" title="Object download">Download Video File</a>';
            } else {
                /* fall back to no preview if it doesn't know the format */
                itemDisplay = '<img class="w-50" src="{{ "/assets/lib/icons/file-earmark.svg" | relative_url }}" alt="No preview found">';
                itemDownload = '<a href="' + item.filename + '" target="_blank" rel="noopener" class="m-2 btn btn-dark" title="Object download">Download Object</a>';
            }
            if (item === record) { itemImage = itemDisplay; }
        };

        /* function to add item metadata */
        function generateMetadata(item) {
            var fields = '<dl>';
            {% for f in fields %}{% if f.browse_link == "true" %}
            if (item[{{ f.field | jsonify }}]) {
                var topics = item[{{ f.field | jsonify }}].split(';');
                var browseLinks = "";
                for (var i = 0, len = topics.length; i < len; i++) {
                    if (topics[i] != "") {
                        browseLinks += '<a class="btn btn-link" href="{{ '/browse.html' | relative_url }}#' + encodeURIComponent(topics[i].trim()) + '">' + topics[i].trim() + '</a> ';
                    }
                }
                fields += '<dt class="field">{{ f.display_name }}:</dt> <dd class="field-value">' + browseLinks + '</dd>';
            }
            {%- else -%}
            if (item[{{ f.field | jsonify }}]) { fields += '<dt class="field">{{ f.display_name }}:</dt> <dd class="field-value">{% if f.external_link == "true" %}<a href="' + item[{{ f.field | jsonify }}] + '" target="_blank" rel="noopener">' + item[{{ f.field | jsonify }}] + '</a>{% else %}' + item[{{ f.field | jsonify }}] + '{% endif %}</dd>'; }
            {% endif %}{% endfor %}
            fields += '</dl>';
            return fields;
        };

        /* function to add download, timeline, and map links */
        function addButtons(item) {
            itemLink = item.format.includes('compound_object') || item.format.includes('multiple') ? compoundDownload : itemDownload;
            {% if stubs contains "timeline" %}
            /* add link to view on timeline */
            if (item.date) {
                var itemYear;
                if (item.date.includes('-')) {
                    itemYear = item.date.split('-')[0];
                } else if (item.date.includes('/')) {
                    itemYear = item.date.split('/').pop();
                } else {
                    itemYear = item.date;
                }
                var timelineButton = '<a href="{{ "/timeline.html" | relative_url }}#y' + itemYear + '" class="m-2 btn btn-outline-dark">View on Timeline</a>';
                /* add timeline link to children only if specified in theme.yml */
                {% if site.data.timeline-child-objects == true %}
                    itemLink += timelineButton;
                {% else %}
                    if (item === record) { itemLink += timelineButton; }
                {% endif %}
            }
            {%- endif -%}
            {% if stubs contains "map" %}
            /* add link to view on map */
            var mapButton = '<a href="{{ '/map.html' | relative_url }}#' + item.latitude + ',' + item.longitude + '" class="m-2 btn btn-outline-dark">View on Map</a>';
            if (item.latitude && item.longitude) {
                /* add map link to children only if specified in theme.yml */
                {% if site.data.theme.map-child-objects == true %}
                    itemLink += mapButton;
                {% else %}
                    if (item === record) { itemLink += mapButton; }
                {% endif %}
            }
            {%- endif -%}
        };

        /* create compound object cards */
        function compoundItems() {
            var objectCount = Object.keys(compoundObject).length;
            itemImage = format.includes('compound_object') ? '<div class="row row-cols-2 row-cols-lg-4 g-2">' : "";
            compoundDownload = '<div class="dropdown d-inline"><button class="btn btn-dark dropdown-toggle" type="button" title="Object download" id="compoundButton" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Download Items</button> <div class="dropdown-menu" aria-labelledby="compoundButton">';

            /* generate a modal and card for each item in compound object */
            for (let i = 0; i < compoundObject.length; i++) {
                var compoundLink = compoundObject[i].filename;
                var compoundFormat = compoundObject[i].format;
                var compoundTitle = compoundObject[i].title;
                var partOrder = i + 1;

                /* account for items without title */
                var itemTitle = typeof compoundTitle !== 'undefined' ? `<a id="${compoundObject[i].id}" onclick="window.location.hash='${compoundObject[i].id}'" type="button" class="small mb-2 text-dark" data-bs-toggle="modal" data-bs-target="#${compoundObject[i].id}Modal">${compoundTitle.split(" ").splice(0,4).join(" ")}...</a><br>` : '';

                /* get thumb for card */
                var compoundIcon, compoundThumb;
                if (compoundFormat.includes('image')) {
                    compoundIcon = compoundLink;
                } else if (compoundFormat.includes('pdf')) {
                    compoundIcon = 'icon-pdf';
                } else if (compoundFormat.includes('audio')) {
                    compoundIcon = 'icon-audio';
                } else if (compoundFormat.includes('video')) {
                    compoundIcon = 'icon-video';
                } else {
                    compoundIcon = 'icon-default';
                }

                if (compoundFormat.includes('image')) {
                    compoundThumb = `<img class="img-thumbnail w-50" src="${compoundIcon}" alt="image of ${compoundTitle ? compoundTitle : objectTitle + ', part ' + partOrder}">`;
                } else {
                    compoundThumb = `
                        <svg class="bi compound-thumb text-body" fill="currentColor" aria-hidden="true">
                            <use xlink:href="{{ '/assets/lib/cb-icons.svg' | relative_url }}#${compoundIcon}" />
                        </svg>
                        <span class="sr-only d-none">${compoundTitle ? compoundTitle : 'Part ' + partOrder + ' of ' + objectTitle} - ${compoundFormat}</span>`;
                }

                /* capture index for previous and next modal items */
                var itemPrev = i === 0 ? compoundObject.length : i;
                var itemNext = i + 1 === compoundObject.length ? 1 : i + 2;

                /* create item display and item download link */
                addItem(compoundObject[i]);

                /* create timeline button and map button */
                addButtons(compoundObject[i]);

                /* function to add item download link to dropdown */
                function addDownloadLink() {
                    compoundDownload += `<a class="dropdown-item" target="_blank" rel="noopener" href="${compoundLink}">${compoundTitle ? compoundTitle.split(" ").splice(0,3).join(" ") + '... (' + compoundFormat + ')' : 'Part ' + partOrder + ' of ' + objectTitle}</a>`;
                };

                if (format.includes('multiple')) {
                    /* add full size item to page */
                    itemImage += `
                        <div id="${compoundObject[i].id}">
                            ${itemDisplay + `<p class="text-secondary text-center"><small>${compoundTitle ? compoundTitle : 'Part ' + partOrder + ' of ' + objectTitle}</small></p>`}
                        </div>`;
                    /* add item download link to dropdown */
                    addDownloadLink();
                } else if (format.includes('compound_object')) {
                    /* create compound object modal */
                    var itemModal = `
                        <div class="modal fade" id="${compoundObject[i].id}Modal" tabindex="-1" role="dialog" aria-labelledby="${compoundObject[i].id}ModalLabel" aria-hidden="true">
                            <div class="modal-dialog" role="document" style="max-width: 90% !important;">
                                <div class="modal-content">

                                    <div class="w-100 text-right mb-0">
                                        <button type="button" class="btn-close float-end" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>

                                    <div class="modal-header">
                                        <div class="modal-title w-100" id="${compoundObject[i].id}ModalLabel">
                                            <div class="row">
                                                <div class="col-1 col-md-2 text-right">
                                                    <button onclick="document.getElementById('item-${itemPrev}').click();window.location.hash='item-${itemPrev}'" class="btn btn-outline-dark btn-sm">{% include feature/icon.html icon="arrow-left" label="Left arrow" %} <span class="d-none d-md-inline">Previous Item</span></button>
                                                </div>
                                                <div class="col-9 col-md-8 text-center">
                                                    <h5>${compoundTitle ? compoundTitle + '<span class="d-none d-md-inline"> -</span>' : ''} <span class="d-md-none"><br></span> Item ${partOrder} of ${compoundObject.length}</h5>
                                                </div>
                                                <div class="col-1 col-md-2 text-left">
                                                    <button onclick="document.getElementById('item-${itemNext}').click();window.location.hash='item-${itemNext}'" class="ms-md-5 btn btn-outline-dark btn-sm"><span class="d-none d-md-inline">Next Item</span> {% include feature/icon.html icon="arrow-right" label="Right arrow" %}</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="modal-body">
                                        <div class="row">
                                            <div class="col-md-8">
                                                <div class="card mb-4 text-center">
                                                    <div class="m-2">
                                                        <p>${itemDisplay}</p>
                                                    </div>

                                                    <div class="my-2">
                                                        ${itemLink}
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="col-md-4">
                                                <div class="metadata">
                                                    ${generateMetadata(compoundObject[i])}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;

                    /* return the compound object card */
                    itemImage += `
                        <div class="col">
                            <div class="card h-100">
                                <div class="my-auto">
                                    <div class="p-2 text-center">
                                        ${itemTitle}
                                        ${compoundThumb}
                                    </div>
                                    <p class="text-center mb-5">
                                        <a id="item-${i+1}" onclick="window.location.hash='${compoundObject[i].id}'" type="button" class="btn btn-sm btn-outline-secondary small stretched-link" data-bs-toggle="modal" data-bs-target="#${compoundObject[i].id}Modal">${compoundFormat.toUpperCase()} + Info</a>
                                    </p>
                                    ${itemModal}
                                </div>
                            </div>
                        </div>
                    `;

                    /* add item download link to dropdown */
                    addDownloadLink();
                }
            }
            if (format.includes('compound_object')) { itemImage += '</div>'; }
            compoundDownload += '</div></div>';
        };

        /* add items to page; generate compound objects if applicable */
        compoundObject ? compoundItems() : addItem(record);

        /* add download, timeline, and map button links */
        addButtons(record);

        /* add content to item display area */
        document.getElementById("item-image").innerHTML = itemImage;
        document.getElementById("item-link").innerHTML = itemLink;
        
        /* trigger Gallery for images */
        // ?

        /* add item metadata */
        document.getElementById("item-metadata").innerHTML = generateMetadata(record);

        {% if site.data.theme.browse-buttons == true %}
        /* add prev/next nav */
        var itemKeys = Object.keys(items);
        var current = itemKeys.indexOf(queryString);
        var last = itemKeys.length - 1;
        var back, forward;
        if (current === 0) {
            back = itemKeys[last];
        } else { 
            back = itemKeys[current - 1];
        }
        if (current === last) {
            forward = itemKeys[0];
        } else {
            forward = itemKeys[current + 1];
        }
        var backUrl = "{{ '/item.html?id=' | relative_url }}" + back;
        var forwardUrl = "{{ '/item.html?id=' | relative_url }}" + forward;
        /* add side buttons to page */
        document.getElementById("back-button").href = backUrl;
        document.getElementById("next-button").href = forwardUrl;
        /* add bottom buttons to page */
        document.getElementById("prev-button").href = backUrl;
        document.getElementById("for-button").href = forwardUrl;

        /* add back forward key press */
        document.onkeydown = function(evt) {
        evt = evt || window.event;
        switch (evt.keyCode) {
            case 37:
            location.href = backUrl;
                break;
            case 39:
            location.href = forwardUrl;
                break;
        }};
        {%- endif -%}
        
    } else {
        /* no item with that ID */
        document.getElementById("bc-title").innerHTML = 'Not found?';
        document.getElementById("item-title").innerHTML = 'Sorry, item not found. Please visit <a href="{{ "/browse.html" | relative_url }}">Browse page</a> to find an item.';
    }

    /* all done, so hide loading animation */
    document.getElementById("loading").style.display = "none";

})();

</script>